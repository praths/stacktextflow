<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: script.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: script.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var stacktextflow = {
	
	/** This function is called to initialize the editor */
	init: function (){
		/* Setting up the main editor */
		
		$("#sto-menu").on("click", "button", stacktextflow.menuButtonClicked);
		$("#sto-post").click(stacktextflow.post);
		$("#sto-discard").click(stacktextflow.discard);
		
		/* Detect shortcuts */
		$(document).keydown(stacktextflow.events.keydown);
		
		/* Activating Bootstrap Tooltips */
		$('#sto-menu button').tooltip({
			"delay": { show: 650, hide: 50 },
			"placement": "bottom"
		});
		
		stacktextflow.editor = $("#sto-editor");
		stacktextflow.editor.on("input keyup paste", stacktextflow.events.edited);
		stacktextflow.editor.on("mousedown keydown focus", stacktextflow.events.changedCaretPosition);
		
		/* Always paste raw text */
		stacktextflow.editor.on('paste',function(e) {
		    e.preventDefault();
		    var text = (e.originalEvent || e).clipboardData.getData('text/plain') || prompt('Paste something..');
		    document.execCommand('insertText', false, text);
		});
		
		/* Enabling messaging with the injectScript */
		window.addEventListener("message", stacktextflow.events.receivedMessage, false);
	
		/* Request the value of the stackexchange editor by messaging injectScript */
		stacktextflow.postMessage({ 
			"command": "getSEEditorValue"
		});
		
		/* Setting up the Ace code editor */
		ace.require("ace/ext/language_tools");
		
		stacktextflow.cEditor = ace.edit("code-editor");
	    stacktextflow.cEditor.setTheme("ace/theme/monokai");
	    stacktextflow.cEditor.getSession().setMode("ace/mode/javascript");
	    stacktextflow.cEditor.setOptions({
	        enableBasicAutocompletion: true,
	        enableLiveAutocompletion: true
	    });
	    
	    var codewSelect = $("#codew-modes");
	    var modes = require("ace/ext/modelist").modesByName;
		for (var key in modes) {
			if (modes.hasOwnProperty(key)) {
				codewSelect.append('&lt;option value="' + key + '">' + modes[key].caption + '&lt;/option>');
			}
		}
		codewSelect.find("[value=javascript]").prop("selected",true);
		codewSelect.change(stacktextflow.events.changedCEditMode);
		
		/* The "insert" button handler in the code modal */
		$("#code-insert").click(stacktextflow.events.insertCode);
		
		/* The "insert" button handler in the link modal */
		$("#link-insert").click(stacktextflow.events.insertLink);
	},
	
	/** Cotains all event handlers */
	events: {
	
		insertCode: function (){
			/* The "Insert" button in the "Write Code" modal was clicked */
			$("#codeWriteModal").modal("hide");
			
			stacktextflow.restoreSelection();
			document.execCommand("insertHTML", false, "&lt;div>&lt;pre>" + stacktextflow.cEditor.getValue() + "&lt;/pre>&lt;/div>&lt;br />");
		},
		
		insertLink: function (){
			stacktextflow.insertLink($("#linkField").val());
		},
		
		/** The main editor's content has changed, notify the injectScript which will update the stackexchange editor */
		edited: function (){
			stacktextflow.postMessage({ 
				"command": "edited",
				"value": stacktextflow.editor.html()
			});
		},
		
		/** The user clicked discard, notify the injectScript which will discard in the stackexchange editor */
		discard: function (){
			//
			stacktextflow.postMessage({ 
				"command": "discard",
			});
		},
		
		post: function (){
			//Post the answer thru the submit form
			stacktextflow.postMessage({ 
				"command": "post",
			});
		},
		
		keydown: function (e){
			//Detect shortcuts and click
			if(e.metaKey) return !$('#sto-menu > button[data-shortcut="' + String.fromCharCode(e.keyCode).toUpperCase() + '"]').click().length;
		},
		
		changedCEditMode: function (){
			//The value of the mode select above the code editor was changed, update the mode
			var mode = require("ace/ext/modelist").modesByName[$("#codew-modes").val()];
			stacktextflow.cEditor.getSession().setMode({
			   path: mode.mode,
			   v: Date.now() 
			});
		},
		
		receivedMessage: function(event){
			//Receiving messages from the inject script
			if(event.data.command == "SEEditorValue"){
				stacktextflow.editor.html(event.data.value);
			}
		},
		
		changedCaretPosition: function (){
			
		}
		
	},
	
	insertLink: function (link){
		$("#linkModal").modal("hide");
	
		stacktextflow.restoreSelection();
		document.execCommand("createLink", false, link);	
	},
	
	
	//Utilties for handling selection
	saveSelection: function() {
		//Store the the cursor postition/selection to restore it later
	    if (window.getSelection) {
	        sel = window.getSelection();
	        if (sel.getRangeAt &amp;&amp; sel.rangeCount) {
	            stacktextflow.storedSelection = sel.getRangeAt(0);
	        }
	    } else if (document.selection &amp;&amp; document.selection.createRange) {
	        stacktextflow.storedSelection = document.selection.createRange();
	    }
	},

	restoreSelection: function() {
		//Restore the the cursor postition/selection
	    if (stacktextflow.storedSelection) {
	    	stacktextflow.editor.focus();
	        if (window.getSelection) {
	            sel = window.getSelection();
	            sel.removeAllRanges();
	            sel.addRange(stacktextflow.storedSelection);
	        } else if (document.selection &amp;&amp; stacktextflow.storedSelection.select) {
	            stacktextflow.storedSelection.select();
	        }
	    }
	},
	
	getSelectionText: function() {
	    var text = "";
	    if (window.getSelection) {
	        text = window.getSelection().toString();
	    } else if (document.selection &amp;&amp; document.selection.type != "Control") {
	        text = document.selection.createRange().text;
	    }
	    return text;
	},
		
	isSelectionInsideElement: function(tagName) {
	    var sel, containerNode;
	    tagName = tagName.toUpperCase();
	    if (window.getSelection) {
	        sel = window.getSelection();
	        if (sel.rangeCount > 0) {
	            containerNode = sel.getRangeAt(0).commonAncestorContainer;
	        }
	    } else if ( (sel = document.selection) &amp;&amp; sel.type != "Control" ) {
	        containerNode = sel.createRange().parentElement();
	    }
	    while (containerNode) {
	        if (containerNode.nodeType == 1 &amp;&amp; containerNode.tagName == tagName) {
	            return true;
	        }
	        containerNode = containerNode.parentNode;
	    }
	    return false;
	},
	
	menuButtonClicked: function (e){
		//One of the main editor buttons was clicked
		var cmd = e.currentTarget.getAttribute('data-command');
		if(cmd == "createLink"){
			//User wants to add an link
			stacktextflow.saveSelection();
			
			var selection = stacktextflow.getSelectionText()
			
			//Query DuckDuckGo
			var result = $("#linkAYLF .result");
			
			if(selection) {
				result.html('&lt;div class="spinner">&lt;div class="ball ball-1">&lt;/div>&lt;div class="ball ball-2">&lt;/div>&lt;div class="ball ball-3">&lt;/div>&lt;div class="ball ball-4">&lt;/div>&lt;/div>');
			
				$.ajax({
					type: 'GET',
					url: 'https://api.duckduckgo.com/',
					data: { q: selection, format: 'json', pretty: 1 },
					jsonpCallback: 'jsonp',
					dataType: 'jsonp'
			    }).then(function (data) {
			    	if(!data.AbstractURL) {
				    	result.html('&lt;h4 class="lead text-muted text-center">No results&lt;/h4>');
			    	} else {
			    		var url = data.AbstractURL;
				    	result.html('&lt;div class="well">&lt;h4>' + data.Heading + '&lt;/h4>&lt;p>' + data.Abstract + '&lt;/p>&lt;a href="' + url + '">' + url + '&lt;/a>&lt;button class="btn btn-primary">Use Link&lt;/button>&lt;/div>&lt;div class="text-muted">&lt;small>Quick Answers provided by DuckDuckGo&lt;/small>&lt;/div>').find("button").one("click",function (){
					    	stacktextflow.insertLink(url);
				    	});
			    	}
			    });
			}
			else {
				result.html('&lt;h4 class="lead text-muted text-center">Select text in the editor to see suggestions.&lt;/h4>');
			}
				
			$("#linkModal").modal("show").one("shown.bs.modal", function (){
				$("#linkField").focus();
			});
		}
		else if(cmd == "writeCode"){
			//Launching the write code modal
			stacktextflow.saveSelection();
			
			stacktextflow.cEditor.setValue(""); 
			$("#codeWriteModal").modal("show").one("shown.bs.modal", function (){
				stacktextflow.cEditor.focus();
			});
			
		}
		else {
			document.execCommand(cmd, false, e.currentTarget.getAttribute('data-value'));	
		}
	},
	
	postMessage: function (o){
		window.parent.postMessage(o, "*");
	},
	
};


$(stacktextflow.init);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Wed Aug 20 2014 19:23:06 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
